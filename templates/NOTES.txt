**************************************************
LLAMATOR MCP Server - Successfully Deployed!
**************************************************

Release Name:   {{ .Release.Name }}
Namespace:      {{ include "llamator-mcp.namespace" . }}
Chart Version:  {{ .Chart.Version }}
App Version:    {{ .Chart.AppVersion }}

**************************************************
COMPONENTS DEPLOYED:
**************************************************

{{- if .Values.api.enabled }}
✓ API Server ({{ .Values.api.replicaCount }} replicas)
  - Service: {{ include "llamator-mcp.api.fullname" . }}
  - Port: {{ .Values.api.service.port }}
  {{- if .Values.api.autoscaling.enabled }}
  - HPA: {{ .Values.api.autoscaling.minReplicas }}-{{ .Values.api.autoscaling.maxReplicas }} replicas
  {{- end }}
{{- end }}

{{- if .Values.worker.enabled }}
✓ Worker ({{ .Values.worker.replicaCount }} replicas)
  {{- if .Values.worker.autoscaling.enabled }}
  - HPA: {{ .Values.worker.autoscaling.minReplicas }}-{{ .Values.worker.autoscaling.maxReplicas }} replicas
  {{- end }}
{{- end }}

{{- if .Values.redis.enabled }}
✓ Redis
  - Service: {{ include "llamator-mcp.redis.fullname" . }}
  - Port: {{ .Values.redis.service.port }}
  {{- if .Values.redis.persistence.enabled }}
  - Persistence: Enabled ({{ .Values.redis.persistence.size }})
  {{- end }}
{{- end }}

{{- if .Values.artifacts.persistence.enabled }}
✓ Artifacts Storage
  - PVC: {{ include "llamator-mcp.artifacts.pvc.name" . }}
  - Size: {{ .Values.artifacts.persistence.size }}
{{- end }}

**************************************************
SECRETS MANAGEMENT:
**************************************************

{{- if .Values.vault.enabled }}
✓ External Secrets Operator: ENABLED
  - SecretStore: {{ .Values.vault.secretStoreRef }} ({{ .Values.vault.secretStoreKind }})
  - Vault Path: {{ .Values.vault.secretPath }}
  - Refresh: {{ .Values.vault.refreshInterval }}

  ExternalSecrets created:
  - {{ include "llamator-mcp.fullname" . }}-openai-es → {{ .Values.security.openai.attack.secret.name }}
  {{- if .Values.security.apiKey.enabled }}
  - {{ include "llamator-mcp.fullname" . }}-api-key-es → {{ .Values.security.apiKey.existingSecret }}
  {{- end }}
  {{- if .Values.storage.s3.enabled }}
  - {{ include "llamator-mcp.fullname" . }}-s3-keys-es → {{ .Values.storage.s3.existingSecret }}
  {{- end }}

  Vault secrets structure:
    kv/data/team11/llamator/openai → OPENAI_API_KEY
    kv/data/team11/llamator/api    → API_KEY
    kv/data/team11/llamator/s3     → ACCESS_KEY_ID, SECRET_ACCESS_KEY

{{- else }}
⚠ External Secrets: DISABLED

  You must create secrets manually:

  kubectl create secret generic {{ .Values.security.openai.attack.secret.name }} \
    --from-literal={{ .Values.security.openai.attack.secret.key }}='YOUR_API_KEY' \
    --from-literal={{ .Values.security.openai.judge.secret.key }}='YOUR_API_KEY' \
    --from-literal={{ .Values.security.openai.target.secret.key }}='YOUR_API_KEY' \
    --namespace {{ include "llamator-mcp.namespace" . }}

  {{- if .Values.security.apiKey.enabled }}
  kubectl create secret generic {{ .Values.security.apiKey.existingSecret }} \
    --from-literal={{ .Values.security.apiKey.secretKey }}='YOUR_SECURE_API_KEY' \
    --namespace {{ include "llamator-mcp.namespace" . }}
  {{- end }}
{{- end }}

**************************************************
SECURITY:
**************************************************

{{- if .Values.serviceAccount.create }}
✓ ServiceAccount: {{ include "llamator-mcp.serviceAccountName" . }}
{{- end }}

{{- if .Values.rbac.create }}
✓ RBAC: Role and RoleBinding created
{{- end }}

{{- if .Values.networkPolicy.enabled }}
✓ NetworkPolicy: Enabled
{{- else }}
✗ NetworkPolicy: Disabled
{{- end }}

{{- if .Values.security.apiKey.enabled }}
✓ API Key Authentication: ENABLED
  Secret: {{ .Values.security.apiKey.existingSecret }}
{{- else }}
⚠ API Key Authentication: DISABLED (not recommended for production)
{{- end }}

**************************************************
ACCESS INFORMATION:
**************************************************

{{- if .Values.ingress.enabled }}

1. External Access (via Ingress):

{{- range .Values.ingress.hosts }}
   URL: https://{{ .host }}
{{- end }}

{{- if .Values.ingress.tls }}
   TLS/HTTPS: Enabled ✓
{{- else }}
   ⚠ WARNING: TLS not configured!
{{- end }}

{{- else }}

1. Internal Access (ClusterIP):

   API Service: {{ include "llamator-mcp.api.fullname" . }}.{{ include "llamator-mcp.namespace" . }}.svc.cluster.local:{{ .Values.api.service.port }}

2. Port Forward (for testing):

   kubectl port-forward -n {{ include "llamator-mcp.namespace" . }} svc/{{ include "llamator-mcp.api.fullname" . }} 8000:{{ .Values.api.service.port }}
   
   Then access: http://localhost:8000

{{- end }}

**************************************************
VERIFY DEPLOYMENT:
**************************************************

1. Check ExternalSecrets status:
   kubectl get externalsecret -n {{ include "llamator-mcp.namespace" . }}

2. Check secrets created:
   kubectl get secret -n {{ include "llamator-mcp.namespace" . }}

3. Check all resources:
   kubectl get all -n {{ include "llamator-mcp.namespace" . }}

4. Wait for pods to be ready:
   kubectl wait --for=condition=ready pod \
     -l app.kubernetes.io/name=llamator-mcp \
     -n {{ include "llamator-mcp.namespace" . }} \
     --timeout=300s

5. Test API endpoint:
   curl https://{{ (index .Values.ingress.hosts 0).host }}/health

**************************************************
VIEW LOGS:
**************************************************

API logs:
  kubectl logs -n {{ include "llamator-mcp.namespace" . }} -l app.kubernetes.io/component=api -f

Worker logs:
  kubectl logs -n {{ include "llamator-mcp.namespace" . }} -l app.kubernetes.io/component=worker -f

Redis logs:
  kubectl logs -n {{ include "llamator-mcp.namespace" . }} -l app.kubernetes.io/component=redis -f

**************************************************
TROUBLESHOOTING:
**************************************************

If ExternalSecret fails:
  kubectl describe externalsecret -n {{ include "llamator-mcp.namespace" . }}

If pods fail to start:
  kubectl describe pod -n {{ include "llamator-mcp.namespace" . }} -l app.kubernetes.io/name=llamator-mcp

**************************************************
DOCUMENTATION:
**************************************************

- Project: README.md
- GitHub: https://github.com/CSU-ITMO-2025-2/team11-llamator-mcp

**************************************************
