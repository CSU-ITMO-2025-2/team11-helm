{{- if .Values.api.enabled }}
---
# Helm Test: проверка доступности API health endpoint
apiVersion: v1
kind: Pod
metadata:
  name: {{ include "llamator-mcp.fullname" . }}-test-api-health
  namespace: {{ include "llamator-mcp.namespace" . }}
  labels:
    {{- include "llamator-mcp.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  containers:
    - name: curl
      image: curlimages/curl:8.5.0
      command:
        - sh
        - -c
        - |
          echo "Testing API health endpoint..."
          
          # Wait for service to be ready
          until nc -z {{ include "llamator-mcp.api.fullname" . }} {{ .Values.api.service.port }}; do
            echo "Waiting for API service..."
            sleep 2
          done
          
          # Test health endpoint
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            http://{{ include "llamator-mcp.api.fullname" . }}:{{ .Values.api.service.port }}/health)
          
          echo "Health endpoint returned HTTP $HTTP_CODE"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "✓ API health check passed!"
            exit 0
          else
            echo "✗ API health check failed!"
            exit 1
          fi
{{- end }}

