{{- if .Values.redis.enabled }}
---
# Helm Test: проверка доступности Redis
apiVersion: v1
kind: Pod
metadata:
  name: {{ include "llamator-mcp.fullname" . }}-test-redis
  namespace: {{ include "llamator-mcp.namespace" . }}
  labels:
    {{- include "llamator-mcp.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  containers:
    - name: redis-cli
      image: redis:7.4-alpine
      command:
        - sh
        - -c
        - |
          echo "Testing Redis connectivity..."
          
          # Wait for Redis to be ready
          until redis-cli -h {{ include "llamator-mcp.redis.fullname" . }} -p {{ .Values.redis.service.port }} ping | grep -q PONG; do
            echo "Waiting for Redis..."
            sleep 2
          done
          
          echo "✓ Redis PING successful"
          
          # Test SET and GET
          redis-cli -h {{ include "llamator-mcp.redis.fullname" . }} -p {{ .Values.redis.service.port }} SET test_key "test_value"
          VALUE=$(redis-cli -h {{ include "llamator-mcp.redis.fullname" . }} -p {{ .Values.redis.service.port }} GET test_key)
          
          if [ "$VALUE" = "test_value" ]; then
            echo "✓ Redis SET/GET test passed!"
            redis-cli -h {{ include "llamator-mcp.redis.fullname" . }} -p {{ .Values.redis.service.port }} DEL test_key
            exit 0
          else
            echo "✗ Redis SET/GET test failed!"
            exit 1
          fi
{{- end }}

