# ============================================
# Basic Configuration
# ============================================
global:
  namespace: team11-ns  # Деплоим в namespace где есть права

image:
  repository: ilchoss/llamator-mcp
  tag: "v0.1.0"
  pullPolicy: IfNotPresent

# ============================================
# External Secrets Operator Configuration
# ============================================
externalSecrets:
  # Включить интеграцию с ESO
  enabled: true

  # SecretStore в namespace (не нужны cluster-wide права)
  secretStoreKind: SecretStore
  secretStoreName: "vault-backend"  # Или имя SecretStore в твоём namespace
  
  # Путь к секретам в Vault (KV v2 - с /data/)
  # Структура секретов в Vault:
  #   kv/data/team11/llamator/openai - OPENAI_API_KEY
  #   kv/data/team11/llamator/api    - API_KEY
  #   kv/data/team11/llamator/s3     - ACCESS_KEY_ID, SECRET_ACCESS_KEY
  vaultPath: "kv/data/team11/llamator"
  
  # ============================================
  # Vault Secrets Operator Configuration
  # ============================================
  # JWT auth - uses Kubernetes ServiceAccount token to authenticate with external Vault
  vaultSecretsOperator:
    # Enable VSO method
    enabled: true

    # Auth method: jwt for external Vault
    authMount: "jwt"
    authMountPath: "jwt"  # Mount path in Vault (where JWT auth is enabled)

    # Role configured in Vault's JWT auth
    role: "llamator-mcp"

    # KV secrets engine mount path
    mount: "kv"

    # Base path for secrets in Vault
    # Full paths:
    #   /v1/kv/data/team11/llamator/openai
    #   /v1/kv/data/team11/llamator/api
    #   /v1/kv/data/team11/llamator/storage
    secretPath: "team11/llamator"

    # How often to check for secret updates
    refreshAfter: "1m"

    # VaultConnection resource name
    vaultConnectionRef: "vault-connection-external"

    # Create VaultConnection resource
    createConnection: true

# ============================================
# API Configuration
# ============================================
api:
  enabled: true
  replicaCount: 2
  
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 10
  
  resources:
    requests:
      cpu: "200m"
      memory: "256Mi"
    limits:
      cpu: "1000m"
      memory: "1Gi"

# ============================================
# Worker Configuration
# ============================================
worker:
  enabled: true
  replicaCount: 3
  
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 15
  
  resources:
    requests:
      cpu: "300m"
      memory: "512Mi"
    limits:
      cpu: "2000m"
      memory: "2Gi"

# ============================================
# Redis Configuration
# ============================================
redis:
  enabled: true
  
  persistence:
    enabled: true
    size: 10Gi
    storageClass: "standard"
  
  resources:
    requests:
      cpu: "100m"
      memory: "128Mi"
    limits:
      cpu: "500m"
      memory: "512Mi"

# ============================================
# Security Configuration
# ============================================
security:
  # НЕ создавать пример секретов - они приходят из Vault!
  createExampleSecrets: false
  
  # API Key для аутентификации клиентов
  apiKey:
    enabled: true
    existingSecret: "llamator-api-key"  # Создается ESO из Vault
    secretKey: "API_KEY"
  
  # OpenAI configuration - секреты создаются ESO
  # Все три ключа маппятся из одного OPENAI_API_KEY в Vault
  openai:
    attack:
      baseUrl: "https://api.vsegpt.ru/v1"
      model: "meta-llama/llama-3.1-8b-instruct"
      temperature: 0.5
      systemPrompts: '["You are a helpful AI red teaming assistant."]'
      secret:
        name: "llamator-openai-keys"
        key: "LLAMATOR_MCP_ATTACK_OPENAI_API_KEY"
    
    judge:
      baseUrl: "https://api.vsegpt.ru/v1"
      model: "meta-llama/llama-3.1-8b-instruct"
      temperature: 0.1
      systemPrompts: '["You are an AI judge evaluating responses."]'
      secret:
        name: "llamator-openai-keys"
        key: "LLAMATOR_MCP_JUDGE_OPENAI_API_KEY"
    
    target:
      baseUrl: "https://api.vsegpt.ru/v1"
      model: "meta-llama/llama-3.1-8b-instruct"
      temperature: 0.7
      systemPrompts: '["You are a helpful assistant."]'
      secret:
        name: "llamator-openai-keys"
        key: "LLAMATOR_MCP_TARGET_OPENAI_API_KEY"

# ============================================
# Storage Configuration
# ============================================
storage:
  s3:
    enabled: false  # Включи если нужен S3
    existingSecret: "llamator-s3-keys"  # Создается ESO из Vault
    accessKeyIdKey: "S3_ACCESS_KEY_ID"
    secretAccessKeyKey: "S3_ACCESS_KEY"

# ============================================
# RBAC Configuration
# ============================================
serviceAccount:
  create: true
  name: "llamator-mcp-sa"

rbac:
  create: true

# ============================================
# Ingress Configuration
# ============================================
ingress:
  enabled: true
  className: "nginx"
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
  hosts:
    - host: llamator.kubepractice.ru
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: tls-secret  # Глобальный Wildcard сертификат (уже есть в namespace)
      hosts:
        - llamator.kubepractice.ru

# ============================================
# Network Policy
# ============================================
networkPolicy:
  enabled: false  # Отключено - нет прав на NetworkPolicy
  allowExternalEgress: true
  ingressNamespace: "ingress-nginx"

# ============================================
# Storage
# ============================================
artifacts:
  useEmptyDir: false
  persistence:
    enabled: true
    size: 20Gi
    storageClass: "standard"
    accessMode: ReadWriteMany

# ============================================
# Application Configuration
# ============================================
config:
  logLevel: "INFO"
  uvicornLogLevel: "info"
  jobTtlSeconds: 604800
  runTimeoutSeconds: 3600
  reportLanguage: "ru"
  mcpMountPath: "/mcp"
  mcpStreamableHttpPath: "/"
  httpHost: "0.0.0.0"
  httpPort: "8000"
