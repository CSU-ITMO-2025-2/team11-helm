# =============================================================================
# LLAMATOR MCP Helm Chart - Values for team11
# =============================================================================

# -----------------------------------------------------------------------------
# Global Configuration
# -----------------------------------------------------------------------------
global:
  namespace: team11-ns  # Namespace с правами
  imagePullSecrets: []

nameOverride: ""
fullnameOverride: ""

# -----------------------------------------------------------------------------
# Image Configuration
# -----------------------------------------------------------------------------
image:
  repository: ilchoss/llamator-mcp
  tag: "v0.1.0"
  pullPolicy: IfNotPresent

# -----------------------------------------------------------------------------
# API Server Configuration
# -----------------------------------------------------------------------------
api:
  enabled: true
  replicaCount: 2
  containerPort: 8000
  
  service:
    type: ClusterIP
    port: 8000
    targetPort: 8000
    annotations: {}
  
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80
  
  podDisruptionBudget:
    enabled: false
    minAvailable: 1
  
  livenessProbe:
    enabled: true
    httpGet:
      path: /health
      port: 8000
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  
  readinessProbe:
    enabled: true
    httpGet:
      path: /health
      port: 8000
    initialDelaySeconds: 10
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 3
  
  resources:
    requests:
      cpu: "200m"
      memory: "256Mi"
    limits:
      cpu: "1000m"
      memory: "1Gi"
  
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 1000
  
  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false
    capabilities:
      drop:
        - ALL
  
  podAntiAffinity:
    enabled: false
    topologyKey: kubernetes.io/hostname
  
  nodeSelector: {}
  tolerations: []
  affinity: {}
  podAnnotations: {}

# -----------------------------------------------------------------------------
# Worker Configuration
# -----------------------------------------------------------------------------
worker:
  enabled: true
  replicaCount: 3
  
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 15
    targetCPUUtilizationPercentage: 75
    targetMemoryUtilizationPercentage: 80
  
  podDisruptionBudget:
    enabled: false
    minAvailable: 1
  
  livenessProbe:
    enabled: false
    exec:
      command:
        - pgrep
        - -f
        - arq
    initialDelaySeconds: 30
    periodSeconds: 30
    timeoutSeconds: 10
    failureThreshold: 3
  
  resources:
    requests:
      cpu: "300m"
      memory: "512Mi"
    limits:
      cpu: "2000m"
      memory: "2Gi"
  
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 1000
  
  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false
    capabilities:
      drop:
        - ALL
  
  podAntiAffinity:
    enabled: false
    topologyKey: kubernetes.io/hostname
  
  nodeSelector: {}
  tolerations: []
  affinity: {}
  podAnnotations: {}

# -----------------------------------------------------------------------------
# Redis Configuration
# -----------------------------------------------------------------------------
redis:
  enabled: true
  
  image:
    repository: redis
    tag: "7.4-alpine"
    pullPolicy: IfNotPresent
  
  service:
    type: ClusterIP
    port: 6379
    targetPort: 6379
  
  persistence:
    enabled: true
    size: 10Gi
    storageClass: "standard"
    accessMode: ReadWriteOnce
  
  config:
    appendonly: "yes"
    appendfsync: "everysec"
    maxmemory: ""
    maxmemory_policy: ""
  
  resources:
    requests:
      cpu: "100m"
      memory: "128Mi"
    limits:
      cpu: "500m"
      memory: "512Mi"
  
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 999
    fsGroup: 999
  
  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false
    capabilities:
      drop:
        - ALL

# -----------------------------------------------------------------------------
# Artifacts Storage Configuration
# -----------------------------------------------------------------------------
artifacts:
  useEmptyDir: false
  persistence:
    enabled: true
    size: 20Gi
    storageClass: "standard"
    accessMode: ReadWriteMany

# -----------------------------------------------------------------------------
# Application Configuration
# -----------------------------------------------------------------------------
config:
  logLevel: "INFO"
  uvicornLogLevel: "info"
  jobTtlSeconds: 604800  # 7 days
  runTimeoutSeconds: 3600  # 1 hour
  reportLanguage: "ru"
  httpHost: "0.0.0.0"
  httpPort: "8000"
  mcpMountPath: "/mcp"
  mcpStreamableHttpPath: "/"

# -----------------------------------------------------------------------------
# Security Configuration
# -----------------------------------------------------------------------------
security:
  # НЕ создавать пример секретов - они приходят из Vault
  createExampleSecrets: false
  
  # API Key для аутентификации клиентов
  apiKey:
    enabled: true
    existingSecret: "llamator-api-key"
    secretKey: "API_KEY"
  
  # OpenAI configuration - секреты создаются ESO из Vault
  openai:
    attack:
      baseUrl: "https://api.vsegpt.ru/v1"
      model: "meta-llama/llama-3.1-8b-instruct"
      temperature: 0.5
      systemPrompts: '["You are a helpful AI red teaming assistant."]'
      secret:
        name: "llamator-openai-keys"
        key: "LLAMATOR_MCP_ATTACK_OPENAI_API_KEY"
    
    judge:
      baseUrl: "https://api.vsegpt.ru/v1"
      model: "meta-llama/llama-3.1-8b-instruct"
      temperature: 0.1
      systemPrompts: '["You are an AI judge evaluating responses."]'
      secret:
        name: "llamator-openai-keys"
        key: "LLAMATOR_MCP_JUDGE_OPENAI_API_KEY"
    
    target:
      baseUrl: "https://api.vsegpt.ru/v1"
      model: "meta-llama/llama-3.1-8b-instruct"
      temperature: 0.7
      systemPrompts: '["You are a helpful assistant."]'
      secret:
        name: "llamator-openai-keys"
        key: "LLAMATOR_MCP_TARGET_OPENAI_API_KEY"

# -----------------------------------------------------------------------------
# S3 Storage Configuration
# -----------------------------------------------------------------------------
storage:
  s3:
    enabled: true
    endpoint: "https://s3.regru.cloud"
    bucket: "team11"
    region: ""
    existingSecret: "llamator-s3-keys"
    accessKeyIdKey: "S3_ACCESS_KEY_ID"
    secretAccessKeyKey: "S3_ACCESS_KEY"

# -----------------------------------------------------------------------------
# External Secrets Operator (ESO) - для получения секретов из Vault
# -----------------------------------------------------------------------------
externalSecrets:
  enabled: true
  
  # SecretStore в namespace (не нужны cluster-wide права)
  secretStoreKind: SecretStore
  secretStoreName: "vault-team11"
  
  # Путь к секретам в Vault (KV v2: с /data/)
  # Структура:
  #   kv/data/team11/llamator/openai - OPENAI_API_KEY
  #   kv/data/team11/llamator/api    - API_KEY
  #   kv/data/team11/llamator/s3     - ACCESS_KEY_ID, SECRET_ACCESS_KEY
  vaultPath: "kv/data/team11/llamator"
  
  # Интервал обновления секретов
  refreshInterval: "1m"

# -----------------------------------------------------------------------------
# HashiCorp Vault Agent Injector (альтернативный метод)
# -----------------------------------------------------------------------------
vault:
  enabled: false
  agentInjector:
    enabled: false
    role: "llamator-mcp"
    secretPath: "secret/data/llamator-mcp"

# -----------------------------------------------------------------------------
# Service Account & RBAC
# -----------------------------------------------------------------------------
serviceAccount:
  create: true
  name: "llamator-mcp-sa"
  annotations: {}

rbac:
  create: true
  rules:
    - apiGroups: [""]
      resources: ["pods", "services", "configmaps"]
      verbs: ["get", "list", "watch"]
    - apiGroups: [""]
      resources: ["secrets"]
      verbs: ["get"]

# -----------------------------------------------------------------------------
# Ingress Configuration
# -----------------------------------------------------------------------------
ingress:
  enabled: true
  className: "nginx"
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
  hosts:
    - host: "llamator.kubepractice.ru"
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: tls-secret  # Wildcard сертификат (уже есть в namespace)
      hosts:
        - "llamator.kubepractice.ru"

# -----------------------------------------------------------------------------
# Network Policy
# -----------------------------------------------------------------------------
networkPolicy:
  enabled: false  # Отключено - нет прав
  allowExternalEgress: true
  ingressNamespace: "ingress-nginx"
  egressRules: []

# -----------------------------------------------------------------------------
# Monitoring
# -----------------------------------------------------------------------------
monitoring:
  serviceMonitor:
    enabled: false
    interval: "30s"
    path: "/metrics"
    scrapeTimeout: "10s"
    labels: {}
    scheme: ""
    tlsConfig: {}
    relabelings: []
    metricRelabelings: []
  
  podAnnotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "8000"
    prometheus.io/path: "/metrics"

# -----------------------------------------------------------------------------
# Resource Quotas
# -----------------------------------------------------------------------------
resourceQuota:
  enabled: false
  hard:
    requests:
      cpu: "4"
      memory: "8Gi"
    limits:
      cpu: "8"
      memory: "16Gi"
    pods: "20"
    persistentvolumeclaims: "5"
    services: "10"
    secrets: "20"
    configmaps: "20"
  scopeSelector: {}
  scopes: []

# -----------------------------------------------------------------------------
# Limit Range
# -----------------------------------------------------------------------------
limitRange:
  enabled: false
  container:
    default:
      cpu: "500m"
      memory: "512Mi"
    defaultRequest:
      cpu: "100m"
      memory: "128Mi"
    max:
      cpu: "2"
      memory: "4Gi"
    min:
      cpu: "50m"
      memory: "64Mi"
  pvc:
    max:
      storage: "50Gi"
    min:
      storage: "1Gi"
  pod:
    max:
      cpu: "4"
      memory: "8Gi"
    min:
      cpu: ""
      memory: ""

# -----------------------------------------------------------------------------
# Extra Configuration
# -----------------------------------------------------------------------------
extraEnv: []
extraVolumes: []
extraVolumeMounts: []
