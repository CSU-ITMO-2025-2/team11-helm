# =============================================================================
# LLAMATOR MCP Helm Chart - Default Values
# =============================================================================

# -----------------------------------------------------------------------------
# Global Configuration
# -----------------------------------------------------------------------------
global:
  namespace: ""  # Uses Release.Namespace by default
  imagePullSecrets: []
  #   - name: ghcr-secret

nameOverride: ""
fullnameOverride: ""

# -----------------------------------------------------------------------------
# Image Configuration
# -----------------------------------------------------------------------------
image:
  repository: ilchoss/llamator-mcp
  tag: "v0.1.0"
  pullPolicy: IfNotPresent

# -----------------------------------------------------------------------------
# API Server Configuration
# -----------------------------------------------------------------------------
api:
  enabled: true
  replicaCount: 1
  containerPort: 8000
  
  service:
    type: ClusterIP
    port: 8000
    targetPort: 8000
    annotations: {}
  
  autoscaling:
    enabled: false
    minReplicas: 2
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80
  
  podDisruptionBudget:
    enabled: false
    minAvailable: 1
  
  livenessProbe:
    enabled: true
    httpGet:
      path: /health
      port: 8000
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  
  readinessProbe:
    enabled: true
    httpGet:
      path: /health
      port: 8000
    initialDelaySeconds: 10
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 3
  
  resources:
    requests:
      cpu: "100m"
      memory: "128Mi"
    limits:
      cpu: "500m"
      memory: "512Mi"
  
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 1000
  
  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false
    capabilities:
      drop:
        - ALL
  
  podAntiAffinity:
    enabled: false
    topologyKey: kubernetes.io/hostname
  
  nodeSelector: {}
  tolerations: []
  affinity: {}
  podAnnotations: {}

# -----------------------------------------------------------------------------
# Worker Configuration
# -----------------------------------------------------------------------------
worker:
  enabled: true
  replicaCount: 1
  
  autoscaling:
    enabled: false
    minReplicas: 2
    maxReplicas: 15
    targetCPUUtilizationPercentage: 75
    targetMemoryUtilizationPercentage: 80
  
  podDisruptionBudget:
    enabled: false
    minAvailable: 1
  
  livenessProbe:
    enabled: false
    exec:
      command:
        - pgrep
        - -f
        - arq
    initialDelaySeconds: 30
    periodSeconds: 30
    timeoutSeconds: 10
    failureThreshold: 3
  
  resources:
    requests:
      cpu: "100m"
      memory: "128Mi"
    limits:
      cpu: "500m"
      memory: "512Mi"
  
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 1000
  
  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false
    capabilities:
      drop:
        - ALL
  
  podAntiAffinity:
    enabled: false
    topologyKey: kubernetes.io/hostname
  
  nodeSelector: {}
  tolerations: []
  affinity: {}
  podAnnotations: {}

# -----------------------------------------------------------------------------
# Redis Configuration
# -----------------------------------------------------------------------------
redis:
  enabled: true
  
  image:
    repository: redis
    tag: "7.4-alpine"
    pullPolicy: IfNotPresent
  
  service:
    type: ClusterIP
    port: 6379
    targetPort: 6379
  
  persistence:
    enabled: false
    size: 5Gi
    storageClass: ""
    accessMode: ReadWriteOnce
  
  config:
    appendonly: "yes"
    appendfsync: "everysec"
    maxmemory: ""
    maxmemory_policy: ""
  
  resources:
    requests:
      cpu: "50m"
      memory: "64Mi"
    limits:
      cpu: "200m"
      memory: "256Mi"
  
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 999
    fsGroup: 999
  
  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false
    capabilities:
      drop:
        - ALL

# -----------------------------------------------------------------------------
# Artifacts Storage Configuration
# -----------------------------------------------------------------------------
artifacts:
  # Use emptyDir for simple deployments (data is lost on pod restart)
  useEmptyDir: true
  
  persistence:
    enabled: false
    size: 10Gi
    # storageClass must support ReadWriteMany for multi-replica deployments
    storageClass: ""
    accessMode: ReadWriteMany

# -----------------------------------------------------------------------------
# Application Configuration
# -----------------------------------------------------------------------------
config:
  # Logging
  logLevel: "INFO"
  uvicornLogLevel: "info"
  
  # Job execution
  jobTtlSeconds: 604800  # 7 days
  runTimeoutSeconds: 3600  # 1 hour
  
  # Report language
  reportLanguage: "ru"
  
  # HTTP server
  httpHost: "0.0.0.0"
  httpPort: "8000"
  
  # MCP paths
  mcpMountPath: "/mcp"
  mcpStreamableHttpPath: "/"

# -----------------------------------------------------------------------------
# Security Configuration
# -----------------------------------------------------------------------------
security:
  # Create example secrets (only for development/testing)
  createExampleSecrets: false
  
  # API Key authentication for MCP endpoints
  apiKey:
    enabled: false
    existingSecret: "llamator-api-key"
    secretKey: "LLAMATOR_MCP_API_KEY"
  
  # OpenAI configuration for attack, judge, and target models
  openai:
    attack:
      baseUrl: "https://api.vsegpt.ru/v1"
      model: "meta-llama/llama-3.1-8b-instruct"
      temperature: 0.5
      systemPrompts: '["You are a helpful AI red teaming assistant."]'
      secret:
        name: "llamator-openai-keys"
        key: "LLAMATOR_MCP_ATTACK_OPENAI_API_KEY"
    
    judge:
      baseUrl: "https://api.vsegpt.ru/v1"
      model: "meta-llama/llama-3.1-8b-instruct"
      temperature: 0.1
      systemPrompts: '["You are a helpful AI judge assistant."]'
      secret:
        name: "llamator-openai-keys"
        key: "LLAMATOR_MCP_JUDGE_OPENAI_API_KEY"
    
    target:
      baseUrl: "https://api.vsegpt.ru/v1"
      model: "meta-llama/llama-3.1-8b-instruct"
      temperature: 0.7
      systemPrompts: '["You are a helpful assistant."]'
      secret:
        name: "llamator-openai-keys"
        key: "LLAMATOR_MCP_TARGET_OPENAI_API_KEY"

# -----------------------------------------------------------------------------
# S3 Storage Configuration (optional)
# -----------------------------------------------------------------------------
storage:
  s3:
    enabled: true
    # S3 endpoint URL (для reg.ru, AWS, MinIO и т.д.)
    endpoint: "https://s3.regru.cloud"
    bucket: "team11"
    region: ""  # Оставь пустым, если reg.ru не требует
    # Секрет с credentials
    existingSecret: "llamator-s3-keys"
    accessKeyIdKey: "S3_ACCESS_KEY_ID"
    secretAccessKeyKey: "S3_ACCESS_KEY"

# -----------------------------------------------------------------------------
# External Secrets Operator (ESO) - для получения секретов из Vault
# -----------------------------------------------------------------------------
externalSecrets:
  # Включить интеграцию с External Secrets Operator
  enabled: true
  
  # Тип SecretStore (SecretStore - namespace-scoped, ClusterSecretStore - cluster-wide)
  secretStoreKind: SecretStore
  
  # Имя ClusterSecretStore (должен быть уже создан в кластере)
  secretStoreName: "vault-backend"
  
  # Базовый путь к секретам в Vault (KV v2: с /data/)
  # Секреты:
  #   {vaultPath}/openai - OPENAI_API_KEY
  #   {vaultPath}/api    - API_KEY
  #   {vaultPath}/s3     - ACCESS_KEY_ID, SECRET_ACCESS_KEY
  vaultPath: "kv/data/team11/llamator"
  
  # Интервал обновления секретов из Vault
  refreshInterval: "1m"

# -----------------------------------------------------------------------------
# HashiCorp Vault Agent Injector (альтернативный метод)
# -----------------------------------------------------------------------------
vault:
  # Включить Vault Agent Injector
  enabled: false
  # Vault Agent Injector (sidecar-based) - если нужен прямой доступ к Vault
  agentInjector:
    enabled: false
    role: "llamator-mcp"
    secretPath: "secret/data/llamator-mcp"

  # Vault Secrets Operator (CRD-based)
  # Supported auth methods: kubernetes, jwt, appRole (NOT userpass!)
  vaultSecretsOperator:
    enabled: false
    # Auth method: kubernetes, jwt, or appRole
    authMount: "kubernetes"
    authMountPath: ""  # Custom mount path (default: same as authMount)
    role: "llamator-mcp"
    # For appRole auth
    appRole:
      roleId: ""
      secretRef: "vault-approle-secret"
      secretKey: "secret-id"
    # General settings
    mount: "secret"
    secretPath: "llamator-mcp"
    refreshAfter: "5m"
    vaultConnectionRef: "vault-connection"
    createConnection: true

# -----------------------------------------------------------------------------
# Service Account & RBAC
# -----------------------------------------------------------------------------
serviceAccount:
  create: true
  name: ""
  annotations: {}

rbac:
  create: true
  rules:
    - apiGroups: [""]
      resources: ["pods", "services", "configmaps"]
      verbs: ["get", "list", "watch"]
    - apiGroups: [""]
      resources: ["secrets"]
      verbs: ["get"]

# -----------------------------------------------------------------------------
# Ingress Configuration
# -----------------------------------------------------------------------------
ingress:
  enabled: true
  className: "nginx"
  annotations:
    # Wildcard сертификат уже есть - cert-manager не нужен
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
  hosts:
    - host: "llamator.kubepractice.ru"
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: tls-secret  # Глобальный Wildcard сертификат (уже есть в namespace)
      hosts:
        - "llamator.kubepractice.ru"

# -----------------------------------------------------------------------------
# Network Policy
# -----------------------------------------------------------------------------
networkPolicy:
  enabled: true
  # Allow egress to external services (DNS, HTTPS for OpenAI API)
  allowExternalEgress: true
  # Namespace where ingress controller runs
  ingressNamespace: "ingress-nginx"
  # Additional egress rules
  egressRules: []

# -----------------------------------------------------------------------------
# Monitoring
# -----------------------------------------------------------------------------
monitoring:
  serviceMonitor:
    enabled: false
    interval: "30s"
    path: "/metrics"
    scrapeTimeout: "10s"
    labels: {}
    scheme: ""
    tlsConfig: {}
    relabelings: []
    metricRelabelings: []
  
  podAnnotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "8000"
    prometheus.io/path: "/metrics"

# -----------------------------------------------------------------------------
# Resource Quotas
# -----------------------------------------------------------------------------
resourceQuota:
  enabled: false
  hard:
    requests:
      cpu: "4"
      memory: "8Gi"
    limits:
      cpu: "8"
      memory: "16Gi"
    pods: "20"
    persistentvolumeclaims: "5"
    services: "10"
    secrets: "20"
    configmaps: "20"
  scopeSelector: {}
  scopes: []

# -----------------------------------------------------------------------------
# Limit Range
# -----------------------------------------------------------------------------
limitRange:
  enabled: false
  container:
    default:
      cpu: "500m"
      memory: "512Mi"
    defaultRequest:
      cpu: "100m"
      memory: "128Mi"
    max:
      cpu: "2"
      memory: "4Gi"
    min:
      cpu: "50m"
      memory: "64Mi"
  pvc:
    max:
      storage: "50Gi"
    min:
      storage: "1Gi"
  pod:
    max:
      cpu: "4"
      memory: "8Gi"
    min:
      cpu: ""
      memory: ""

# -----------------------------------------------------------------------------
# Extra Configuration
# -----------------------------------------------------------------------------
extraEnv: []
extraVolumes: []
extraVolumeMounts: []
